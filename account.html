<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLC Portal – Account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- UMD build exposes window.supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --card:#f7f7f9; --muted:#666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; }
    .wrap { max-width: 740px; margin: 0 auto; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    header h1 { font-size: 20px; margin: 0; }
    header .muted { color: var(--muted); font-size: 14px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; }
    .col { flex:1 1 220px; }
    .balance { font-size: 28px; font-weight: 700; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .primary { background:#111; color:#fff; }
    .secondary { background:#e9e9ef; }
    pre { background:#111; color:#eee; padding:10px; border-radius:8px; overflow:auto; }
    .tiny { font-size: 12px; color: var(--muted); }
    a { color:#111; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Member Account</h1>
      <div id="whoami" class="muted">loading…</div>
    </div>
    <div>
      <button id="signOut" class="secondary">Sign out</button>
    </div>
  </header>

  <div id="flash" class="tiny"></div>

  <div class="row">
    <div class="card col">
      <div class="muted">Capital Balance</div>
      <div class="balance">$<span id="balance">0.00</span></div>
      <div class="tiny">Updates after Stripe marks your invoice as paid.</div>
      <div style="margin-top:10px;">
        <button id="refresh" class="secondary">Refresh</button>
      </div>
    </div>

    <div class="card col">
      <div class="muted">Contributions</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap: wrap;">
        <button id="startBtn" class="primary">Start / Increase</button>
        <button id="manageBtn" class="secondary">Manage in Portal</button>
      </div>
      <div class="tiny" style="margin-top:8px;">
        “Start / Increase” opens Stripe Checkout.<br/>
        “Manage” opens the Stripe Customer Portal.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="muted">Recent (debug)</div>
    <pre id="debug">waiting…</pre>
  </div>

  <div class="tiny">
    Having trouble? Make sure you’re logged in on this device and contact an admin if you can’t access your account.
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL = 'https://onxkbrjtkparnldcjuqf.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ueGticmp0a3Bhcm5sZGNqdXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODE2ODIsImV4cCI6MjA3MjI1NzY4Mn0.I5JHRN-8rk7oOuWMP5eOWB5PPCz69lgbS-2yvicT3xg';

// Your deployed Supabase Edge Function endpoints:
const START_FN  = 'https://onxkbrjtkparnldcjuqf.supabase.co/functions/v1/start-contribution';
const MANAGE_FN = 'https://onxkbrjtkparnldcjuqf.supabase.co/functions/v1/manage-contribution';

/** ====== INIT ====== **/
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, autoRefreshToken: true }
});

const $ = (id) => document.getElementById(id);

function fmtCents(c) { return (Number(c || 0) / 100).toFixed(2); }

function getQueryFlag(name) {
  const url = new URL(location.href);
  return url.searchParams.get(name);
}

async function requireUser() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    $('whoami').textContent = 'Not signed in';
    throw new Error('No session');
  }
  return user;
}

async function loadMember() {
  const { data, error } = await supabase.from('members').select('id, full_name, email').single();
  if (error) throw error;
  return data;
}

async function loadBalance(memberId) {
  const { data, error } = await supabase
    .from('vw_capital_balances')
    .select('capital_balance_cents')
    .eq('member_id', memberId)
    .single();
  if (error && error.code !== 'PGRST116') throw error; // no row found = 0 balance
  return data?.capital_balance_cents ?? 0;
}

async function refreshAll() {
  try {
    const user = await requireUser();
    $('whoami').textContent = user.email;

    const member = await loadMember();
    $('whoami').textContent = (member.full_name || member.email);

    const cents = await loadBalance(member.id);
    $('balance').textContent = fmtCents(cents);

    const ledger = await supabase.from('capital_ledger').select('*').order('created_at', { ascending: false }).limit(5);
    $('debug').textContent = JSON.stringify({
      user: { id: user.id, email: user.email },
      member,
      balance_cents: cents,
      last_ledger_rows: ledger.data || []
    }, null, 2);

    $('startBtn').onclick = async () => {
      const q = prompt('How many $100 units per month? (e.g., 4 = $400/mo)', '4');
      if (!q) return;
      const quantity = Number(q);
      if (!Number.isFinite(quantity) || quantity < 1) {
        alert('Please enter a whole number ≥ 1');
        return;
      }
      const res = await fetch(START_FN, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ memberId: member.id, quantity })
      });
      if (!res.ok) {
        const txt = await res.text();
        alert('Could not start contribution: ' + txt);
        return;
      }
      const { url } = await res.json();
      location.href = url;
    };

    $('manageBtn').onclick = async () => {
      const res = await fetch(MANAGE_FN, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ memberId: member.id })
      });
      if (!res.ok) {
        const txt = await res.text();
        alert('Could not open portal: ' + txt);
        return;
      }
      const { url } = await res.json();
      location.href = url;
    };

  } catch (e) {
    console.error(e);
    $('debug').textContent = 'Error: ' + (e?.message || e);
  }
}

/** Flash success/cancel messages from Stripe redirect */
(function flashFromQuery() {
  const ok = getQueryFlag('success');
  const cancel = getQueryFlag('cancel');
  if (ok) $('flash').textContent = 'Payment success recorded. Balance will update after the invoice is marked paid.';
  if (cancel) $('flash').textContent = 'Checkout cancelled.';
})();

/** Wire basic controls */
$('refresh').onclick = refreshAll;
$('signOut').onclick = async () => { await supabase.auth.signOut(); location.reload(); };

/** Load on start */
refreshAll();
</script>
</body>
</html>
